# Keeping Netflix Reliable Using Prioritized Load Shedding
[原文地址](https://netflixtechblog.com/keeping-netflix-reliable-using-prioritized-load-shedding-6cc827b02f94)
本文介绍了 Netflix 的流量分级方案，出发点很简单：在最坏情况下，通过优先服务高优的请求，保证用户的核心体验。

## 建立请求分级规则
粗粒度上看，请求被分为三档：
* 不关键，例如日志服务，后台服务。这类请求流量高，占到系统负载的绝大部分
* 影响用户体验
* 核心，一旦挂掉则应用的核心功能无法使用
具体到每类请求， [Zuul](https://github.com/Netflix/zuul) 这一流量入口服务会给出更细粒度的打分，将其修饰在请求本体上向下传递。

## 在合适的位置限流
* 正常情况下，Zuul 监听下游服务的错误率和请求数量。如果发现这两者中的任何一个超出警戒值，则进行按照优先级的递进式限流
* 作为流量入口，Zuul 可以说是整个系统的生命线。如果 Zuul 发现自身的 CPU 利用率 / QPS / 连接数等健康度指标超出阈值，则在入口处直接按优先级大刀阔斧地限流，直到服务恢复健康。
> 看起来这里的初始优先级计算一定是及其轻量、依赖少的，否则卡在计算优先级这一步导致服务不可用会异常危险

## 渐进式限流
这里用了一个奇妙的三次函数来做控制，大意是负载越高时，限流策略越激进。
对于失败的请求，同样按照优先级告诉调用方在多久后开始重试，最多重试几次。很关键，从源头上控制请求量。

## 验证请求分级系统
借助内部工具手动模拟失败情况来验证，同时考虑到产品在持续迭代，通过AB测平台来选取少量真实用户来持续验证当前的分级系统的效果。

最后，说到底限流只是极端情况下对服务的保护，要做到服务自动恢复还有很多别的工作要做。后续需要监测业务无关的一些服务健康度指标时，也可以尝试参考 Zuul。