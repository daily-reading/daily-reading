# Immutability Changes Everything
> 原文地址 http://cidrdb.org/cidr2015/Papers/CIDR15_Paper16.pdf

## 背景
随着数据规则急剧增长、计算核心物理距离增大，从核心见变成数据中心间，给软件系统带来了巨大的协调成本，因此促进了“不可变性”的发展。

## 不可变性给软件系统带来的变化
1. 不可变系统中只允许追加操作（append only），允许根据追加的事实计算出推断性的结论。
2. 不同层级的不可变性
    1. 数据
        1. Data Inside：被传统的关系型数据库管理的数据，通常在服务内部，**可变**
        2. Data Outside：以消息、文件、文档等形式存在与服务外部的数据，**不可变**
    2. 数据集：固定大小的、不可变的数据集合，具有以下特点
        1. 数据集语义上不可变，即不允许直接修改数据集本身，允许从数据集产生新的数据集
        2. 数据集本身不可变，因此可以放心使用，以及通过 denormization 来优化读场景
        3. 不可变数据集是大数据计算的基础，不可变数据集 + 函数式计算过程使得大数据计算能够正确、低成本的容忍失败（通过重试）
        4. 仅有数据集本身，无法保证数据的正确性，因为数据的含义在不同的时间、背景下可能会有不同的含义
        5. 数据集需要元数据来描述其用途和含义，这些元数据通常是描述性的，并且在数据集创建后就是不可变的
3. 不可变数据的版本：数据本身不可变，通过产生新版本的数据来达到更新的效果
    1. 历史
        1. 线性历史：一个版本只会有一个父版本，也最多只会有一个子版本
        2. DAG 历史：版本之间的父子关系是一个 DAG，一个版本可能有多个父、子版本
    2. MVCC
        1. 可以通过 MVCC 的机制来实现逻辑上支持更新的存储系统
    3. LSM Tree
        1. 数据更新通过记录的创建新版本来实现，是一个 Copy On Write 操作
        2. 数据版本会周期性地进行排序和合并，结果写到不可变的文件中，初始文件 level 为 0，此后 level N 的结果写到 level N + 1
        3. 对写操作不友好，对读操作很友好
4. 分布式文件系统 GFS、HDFS
    1. 不可变性：文件、块本身不可变，只允许有一个进程对文件进行追加操作
    2. 不可变性带来了副本的安全性，不用担心数据不一致
    3. 不可变数据结合一致性哈希能够有效的提升稳定性
5. SSD Wear Leveling 本质也是一个 COW，目的是保证每个 block 尽可能使用次数均匀
6. 总结
    1. Copy On Write 是不可变系统最基本的设计模式，通常依次提供“变更”能力
    2. 不可变系统副本也不可变，避免副本不一致的问题，可以放心大胆的使用
    3. 不可变数据集集合关系型数据库为大数据处理带来了更多的应用场景
    4. 不可变性也是有代价的，牺牲了存储空间和写入性能
